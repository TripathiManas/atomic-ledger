<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AtomicLedger - Distributed Transaction System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; transition: opacity 0.5s, bottom 0.5s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; bottom: 40px; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>
    <div id="toast-container"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const ToastManager = ({ toasts, dismissToast }) => {
            return ReactDOM.createPortal(
                <div className="fixed bottom-5 right-5 z-50">
                    {toasts.map(toast => <Toast key={toast.id} {...toast} onDismiss={() => dismissToast(toast.id)} />)}
                </div>,
                document.getElementById('toast-container')
            );
        };
        const Toast = ({ message, type, onDismiss }) => {
            useEffect(() => {
                const timer = setTimeout(() => onDismiss(), 4000);
                return () => clearTimeout(timer);
            }, [onDismiss]);
            return <div className={`toast show ${type} mt-2`}>{message}</div>;
        };
        function App() {
            const [accounts, setAccounts] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [toasts, setToasts] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [isChaosRunning, setIsChaosRunning] = useState(false);
            const addToast = useCallback((message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            }, []);
            const dismissToast = (id) => setToasts(prev => prev.filter(toast => toast.id !== id));
            const fetchData = useCallback(async () => {
                try {
                    const cacheBuster = `?t=${new Date().getTime()}`;
                    const [accRes, txRes] = await Promise.all([fetch(`/api/accounts${cacheBuster}`), fetch(`/api/transactions${cacheBuster}`)]);
                    if (!accRes.ok || !txRes.ok) throw new Error('Network response was not ok');
                    const accData = await accRes.json();
                    const txData = await txRes.json();
                    setAccounts(accData || []);
                    setTransactions(txData || []);
                } catch (error) {
                    console.error("Failed to fetch data:", error);
                    addToast('Failed to fetch data from server', 'error');
                }
            }, [addToast]);
            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 5000);
                return () => clearInterval(interval);
            }, [fetchData]);
            const handleCreateAccount = async () => {
                setIsLoading(true);
                try {
                    const response = await fetch('/api/accounts', { method: 'POST' });
                    if (!response.ok) throw new Error('Failed to create account');
                    await response.json();
                    addToast('New account created successfully!', 'success');
                    fetchData();
                } catch (error) { addToast(error.message, 'error'); }
                setIsLoading(false);
            };
            const handleTransfer = async (event) => {
                event.preventDefault();
                setIsLoading(true);
                const { from, to, amount } = event.target.elements;
                if (from.value === to.value) {
                    addToast("Cannot transfer to the same account.", "error");
                    setIsLoading(false);
                    return;
                }
                try {
                    const payload = { 
                        from_id: from.value, 
                        to_id: to.value, 
                        amount: parseFloat(amount.value) // Amount can still be a number
                    };
                    console.log("Sending transfer payload:", JSON.stringify(payload));
                    const response = await fetch('/api/transfers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const resData = await response.json();
                    if (!response.ok) { throw new Error(resData.error || 'Transfer failed'); }
                    addToast('Transfer successful!', 'success');
                    fetchData();
                } catch (error) { addToast(error.message, 'error'); }
                setIsLoading(false);
            };
            const handleChaos = async () => {
                setIsChaosRunning(true);
                addToast('Simulating node failure... The app should remain available.', 'info');
                try {
                    const response = await fetch('/api/chaos', { method: 'POST' });
                    if (!response.ok) throw new Error('Failed to trigger chaos');
                    const result = await response.json();
                    addToast(result.message, 'success');
                } catch (error) { addToast(error.message, 'error'); }
                setTimeout(() => setIsChaosRunning(false), 5000);
            };
            return (
                <div className="min-h-screen bg-gray-100">
                    <ToastManager toasts={toasts} dismissToast={dismissToast} />
                    <header className="bg-white shadow-sm">
                        <div className="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-gray-900 flex items-center"><span role="img" aria-label="bank" className="mr-3 text-3xl">üè¶</span>AtomicLedger</h1>
                            <button onClick={handleChaos} disabled={isChaosRunning} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:bg-red-400 disabled:cursor-not-allowed disabled:scale-100">Simulate Node Failure</button>
                        </div>
                    </header>
                    <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div className="lg:col-span-2 space-y-8">
                                <div className="bg-white p-6 rounded-lg shadow">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-semibold">Accounts</h2>
                                        <button onClick={handleCreateAccount} disabled={isLoading} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg disabled:bg-blue-400">+ Create Account</button>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account ID</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th></tr></thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {accounts.length > 0 ? accounts.map(acc => (<tr key={acc.id}><td className="px-6 py-4 whitespace-nowrap text-sm font-mono">{acc.id}</td><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">${parseFloat(acc.balance).toFixed(2)}</td></tr>)) : (<tr><td colSpan="2" className="text-center py-4 text-gray-500">No accounts yet. Create one to start!</td></tr>)}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow">
                                    <h2 className="text-xl font-semibold mb-4">Transaction Log</h2>
                                    <div className="overflow-y-auto h-80">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50 sticky top-0"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">From</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">To</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th></tr></thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {transactions.length > 0 ? transactions.map(tx => (<tr key={tx.id}><td className="px-6 py-4 whitespace-nowrap text-sm font-mono">{tx.from_id}</td><td className="px-6 py-4 whitespace-nowrap text-sm font-mono">{tx.to_id}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600">${parseFloat(tx.amount).toFixed(2)}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(tx.created_at).toLocaleTimeString()}</td></tr>)) : (<tr><td colSpan="4" className="text-center py-4 text-gray-500">No transactions yet.</td></tr>)}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow h-fit">
                                <h2 className="text-xl font-semibold mb-4">New Transfer</h2>
                                <form onSubmit={handleTransfer} className="space-y-4">
                                    <div><label htmlFor="from" className="block text-sm font-medium text-gray-700">From Account</label><select id="from" name="from" required className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">{accounts.map(acc => <option key={acc.id} value={acc.id}>{acc.id}</option>)}</select></div>
                                    <div><label htmlFor="to" className="block text-sm font-medium text-gray-700">To Account</label><select id="to" name="to" required className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">{accounts.map(acc => <option key={acc.id} value={acc.id}>{acc.id}</option>)}</select></div>
                                    <div><label htmlFor="amount" className="block text-sm font-medium text-gray-700">Amount</label><input type="number" name="amount" id="amount" required min="0.01" step="0.01" className="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2"/></div>
                                    <button type="submit" disabled={isLoading || accounts.length < 2} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-green-400 disabled:cursor-not-allowed">Submit Transfer</button>
                                </form>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>